<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ReadTogether</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    #ttsBtn { display: none; }
    #feedbackTtsBtn { display: none; }
    #submitBtn { display: none; }
    #ttsAudio { display: none; }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .user-info {
      font-size: 16px;
      color: #1565c0;
      margin-top: 5px;
    }
    .logout-btn {
      background-color: #f44336;
      padding: 10px 20px;
      font-size: 16px;
    }
    .logout-btn:hover {
      background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <div class="header-left">
      <a href="/" style="padding: 0; background: none; text-decoration: none; display: inline-block;">
        <img src="/static/WordyBirdyLogo.png" alt="WordyBirdy Logo" style="width: 60px; height: auto;">
      </a>
      <div>
        <h1 id="assignmentTitle" style="margin: 0;">ReadTogether</h1>
        <p class="user-info" id="studentInfo">Loading...</p>
      </div>
    </div>
    <button class="logout-btn" onclick="handleLogout()">Logout</button>
  </div>
  <a href="/student">‚Üê Back to Assignments</a>
  
  <p>Read the passage below and click Start when ready.</p>

  <div id="passageContainer" style="background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.15); margin: 20px 0;">
    <div id="passage" style="font-size: 24px; line-height: 1.8; color: #333; white-space: pre-wrap;"></div>
  </div>
  
  <button id="startBtn" class="btn">Start</button>
  <button id="stopBtn" class="btn" disabled>Stop</button>
  <p id="status"></p>


    <!-- ‚úÖ TTS Feature -->
  <button id="ttsBtn">üîä Hear it correctly</button>
  <audio id="ttsAudio"></audio>

  <h3>Transcript:</h3>
  <pre id="transcript"></pre>

  <h3>Feedback:</h3>
  <div id="wordFeedback"></div>
  <p id="accuracy"></p>

  <h3>Encouragement:</h3>
  <p id="encouragement"></p>
  
  <h3>Tips:</h3>
  <div id="tips"></div>
  
  <h3>Questions:</h3>
  <div id="questions"></div>
  
  <button id="feedbackTtsBtn">üîä Hear your feedback</button>

  <button id="submitBtn">Submit Assignment</button>

  <script>
    let currentAssignmentId = null;
    let currentMinAccuracy = null;
    let currentUser = null;
    
    // Load user info
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/current-user');
        if (response.ok) {
          currentUser = await response.json();
          document.getElementById('studentInfo').textContent = `Student: ${currentUser.full_name}`;
        } else {
          window.location.href = '/';
        }
      } catch (err) {
        console.error('Error loading user info:', err);
        window.location.href = '/';
      }
    }
    
    // Handle logout
    async function handleLogout() {
      try {
        await fetch('/api/logout', { method: 'POST' });
        window.location.href = '/';
      } catch (err) {
        console.error('Error logging out:', err);
        window.location.href = '/';
      }
    }
    
    // Load assignment if ID is provided in URL
    async function loadAssignment() {
      const urlParams = new URLSearchParams(window.location.search);
      const assignmentId = urlParams.get('id');
      
      if (assignmentId) {
        try {
          currentAssignmentId = assignmentId;
          const response = await fetch(`/api/assignments/${assignmentId}`);
          if (response.ok) {
            const assignment = await response.json();
            document.getElementById('assignmentTitle').textContent = assignment.title;
            document.getElementById('passage').textContent = assignment.text;
            currentMinAccuracy = assignment.min_accuracy || 80;
          }
        } catch (err) {
          console.error('Error loading assignment:', err);
        }
      }
    }
    
    // Monitor accuracy to show/hide submit button
    function checkAccuracy() {
      const accuracyText = document.getElementById('accuracy').textContent;
      const match = accuracyText.match(/(\d+\.?\d*%)/);
      
      if (match && currentMinAccuracy !== null) {
        const accuracy = parseFloat(match[1]);
        const submitBtn = document.getElementById('submitBtn');
        
        if (accuracy >= currentMinAccuracy) {
          submitBtn.style.display = 'block';
        } else {
          submitBtn.style.display = 'none';
        }
      }
    }
    
    // Submit button click handler
    document.getElementById('submitBtn').addEventListener('click', async () => {
      if (!currentAssignmentId) return;
      
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      try {
        const response = await fetch('/api/submit-assignment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            assignment_id: parseInt(currentAssignmentId)
          })
        });
        
        if (response.ok) {
          alert('Assignment submitted successfully!');
          submitBtn.textContent = 'Submitted ‚úì';
          submitBtn.disabled = true;
        } else {
          alert('Error submitting assignment');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Assignment';
        }
      } catch (err) {
        alert('Error submitting assignment: ' + err.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Assignment';
      }
    });
    
    // Initialize
    loadUserInfo();
    loadAssignment();
    
    // Check accuracy periodically (after app.js runs)
    setTimeout(() => {
      setInterval(checkAccuracy, 1000);
    }, 2000);
  </script>
  <script src="/static/app.js"></script>
</body>
</html>

